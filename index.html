<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrainHub - Interactive Video Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Setup Screen */
        .setup-screen {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 50px;
            max-width: 600px;
            margin: 100px auto;
            text-align: center;
        }

        .setup-screen h1 {
            font-size: 36px;
            margin-bottom: 10px;
            color: #333;
        }

        .setup-screen p {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .info-box {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            text-align: left;
            font-size: 14px;
        }

        .info-box strong {
            display: block;
            margin-bottom: 8px;
            color: #1565c0;
        }

        .loading {
            display: none;
            margin-top: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Video Call Screen */
        .video-screen {
            display: none;
        }

        .video-screen.show {
            display: block;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .header h2 {
            font-size: 24px;
            color: #333;
        }

        .room-info {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            aspect-ratio: 16/9;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .video-label {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10;
        }

        .no-video {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
        }

        .no-video-icon {
            width: 80px;
            height: 80px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin: 0 auto 10px;
        }

        .recording-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #dc3545;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: none;
            animation: pulse 1.5s infinite;
        }

        .recording-badge.show {
            display: block;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: #667eea;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s;
            position: relative;
        }

        .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .control-btn.active {
            background: #dc3545;
        }

        .control-btn.recording {
            background: #dc3545;
            animation: pulse 1.5s infinite;
        }

        .control-btn.leave {
            background: #dc3545;
        }

        .control-label {
            position: absolute;
            bottom: -22px;
            font-size: 11px;
            color: #333;
            font-weight: 600;
            white-space: nowrap;
        }

        .participants-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .participants-panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }

        .participant-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .participant-badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .chat-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .chat-panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }

        .chat-messages {
            height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            font-size: 14px;
        }

        .message strong {
            color: #667eea;
        }

        .message.system {
            background: #e3f2fd;
            color: #1565c0;
            font-style: italic;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }

        .chat-input button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .video-grid {
                grid-template-columns: 1fr;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .setup-screen {
                padding: 30px;
            }
        }
    </style>
</head>
<body>
    <!-- Setup Screen -->
    <div class="setup-screen" id="setupScreen">
        <h1>üéì TrainHub</h1>
        <p>Professional Video Training Platform</p>

        <div class="input-group">
            <label for="userName">Your Name</label>
            <input type="text" id="userName" placeholder="Enter your full name" value="">
        </div>

        <div class="input-group">
            <label for="roomId">Room Code</label>
            <input type="text" id="roomId" placeholder="Enter room code to join existing session" value="">
        </div>

        <button class="btn" id="joinBtn" onclick="joinSession()">Join Video Session</button>

        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #666;">Connecting to video session...</p>
        </div>

        <div class="info-box">
            <strong>üìã Instructions:</strong>
            1. Enter your name<br>
            2. Create a new room code (e.g., "Training123") or enter an existing one<br>
            3. Share the room code with others to join the same session<br>
            4. Click "Join Video Session" and allow camera/microphone access<br>
            5. Others can join by entering the same room code
        </div>
    </div>

    <!-- Video Call Screen -->
    <div class="video-screen" id="videoScreen">
        <div class="container">
            <div class="header">
                <h2>üéì TrainHub Session</h2>
                <div class="room-info">Room: <span id="currentRoom"></span></div>
            </div>

            <div class="video-grid" id="videoGrid">
                <!-- Videos will be added here dynamically -->
            </div>

            <div class="controls">
                <button class="control-btn" id="micBtn" onclick="toggleMic()">
                    üé§
                    <span class="control-label">Mic</span>
                </button>
                <button class="control-btn" id="camBtn" onclick="toggleCamera()">
                    üìπ
                    <span class="control-label">Camera</span>
                </button>
                <button class="control-btn" id="screenBtn" onclick="toggleScreen()">
                    üñ•Ô∏è
                    <span class="control-label">Screen</span>
                </button>
                <button class="control-btn" id="recordBtn" onclick="toggleRecording()">
                    ‚è∫
                    <span class="control-label">Record</span>
                </button>
                <button class="control-btn leave" onclick="leaveSession()">
                    üìû
                    <span class="control-label">Leave</span>
                </button>
            </div>

            <div class="participants-panel">
                <h3>üë• Participants (<span id="participantCount">0</span>)</h3>
                <div class="participant-list" id="participantList"></div>
            </div>

            <div class="chat-panel">
                <h3>üí¨ Chat</h3>
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Type a message..." onkeypress="handleChatKey(event)">
                    <button onclick="sendChat()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let peer = null;
        let myPeerId = null;
        let localStream = null;
        let userName = '';
        let roomId = '';
        let connections = {};
        let dataConnections = {};
        let isMuted = false;
        let isCameraOff = false;
        let isScreenSharing = false;
        let screenStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let isRecording = false;

        // Join session
        async function joinSession() {
            userName = document.getElementById('userName').value.trim();
            roomId = document.getElementById('roomId').value.trim().toUpperCase();

            if (!userName) {
                alert('Please enter your name');
                return;
            }

            if (!roomId) {
                alert('Please enter a room code');
                return;
            }

            // Show loading
            document.getElementById('joinBtn').disabled = true;
            document.getElementById('loadingIndicator').classList.add('show');

            try {
                // Request camera and microphone
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                console.log('Got local stream:', localStream);

                // Initialize PeerJS with cloud server
                const uniqueId = roomId + '-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                peer = new Peer(uniqueId, {
                    host: 'trainhub-signal.herokuapp.com',
                    secure: true,
                    port: 443,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            { urls: 'stun:stun3.l.google.com:19302' },
                            { urls: 'stun:stun4.l.google.com:19302' }
                        ]
                    }
                });

                peer.on('open', (id) => {
                    console.log('Connected with peer ID:', id);
                    myPeerId = id;
                    
                    // Switch to video screen
                    document.getElementById('setupScreen').style.display = 'none';
                    document.getElementById('videoScreen').classList.add('show');
                    document.getElementById('currentRoom').textContent = roomId;

                    // Add own video
                    addVideoStream(localStream, userName + ' (You)', true);
                    addParticipant(userName + ' (You)');
                    addChatMessage('System', 'You joined the session', true);

                    // Announce presence
                    announceToRoom();
                    
                    // Listen for new connections every 2 seconds
                    setInterval(announceToRoom, 2000);
                });

                peer.on('call', (call) => {
                    console.log('Receiving call from:', call.peer);
                    call.answer(localStream);
                    
                    call.on('stream', (remoteStream) => {
                        console.log('Received remote stream');
                        const remoteName = call.metadata?.name || 'Participant';
                        addVideoStream(remoteStream, remoteName, false, call.peer);
                    });

                    call.on('close', () => {
                        console.log('Call closed:', call.peer);
                        removeVideoStream(call.peer);
                    });

                    connections[call.peer] = call;
                });

                peer.on('connection', (conn) => {
                    console.log('Data connection from:', conn.peer);
                    setupDataConnection(conn);
                });

                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    alert('Connection error. Please try again.');
                    location.reload();
                });

            } catch (error) {
                console.error('Error:', error);
                alert('Could not access camera/microphone. Please ensure you have granted permissions and try again.');
                document.getElementById('joinBtn').disabled = false;
                document.getElementById('loadingIndicator').classList.remove('show');
            }
        }

        function announceToRoom() {
            if (!peer || !myPeerId) return;

            // Store presence in localStorage with timestamp
            const roomData = JSON.parse(localStorage.getItem('trainhub-' + roomId) || '{}');
            roomData[myPeerId] = {
                name: userName,
                timestamp: Date.now()
            };
            
            // Remove old entries (older than 10 seconds)
            const now = Date.now();
            Object.keys(roomData).forEach(peerId => {
                if (now - roomData[peerId].timestamp > 10000 && peerId !== myPeerId) {
                    delete roomData[peerId];
                }
            });
            
            localStorage.setItem('trainhub-' + roomId, JSON.stringify(roomData));

            // Try to connect to all peers in room
            Object.keys(roomData).forEach(peerId => {
                if (peerId !== myPeerId && !connections[peerId]) {
                    connectToPeer(peerId, roomData[peerId].name);
                }
            });
        }

        function connectToPeer(peerId, remoteName) {
            console.log('Connecting to peer:', peerId);

            // Call with video
            const call = peer.call(peerId, localStream, {
                metadata: { name: userName }
            });

            if (call) {
                call.on('stream', (remoteStream) => {
                    console.log('Got stream from:', peerId);
                    addVideoStream(remoteStream, remoteName, false, peerId);
                });

                call.on('close', () => {
                    removeVideoStream(peerId);
                });

                connections[peerId] = call;
            }

            // Data connection for chat
            const conn = peer.connect(peerId, {
                metadata: { name: userName }
            });
            setupDataConnection(conn);
        }

        function setupDataConnection(conn) {
            dataConnections[conn.peer] = conn;

            conn.on('open', () => {
                console.log('Data channel open:', conn.peer);
                conn.send({
                    type: 'join',
                    name: userName
                });
            });

            conn.on('data', (data) => {
                handleData(data, conn.peer);
            });

            conn.on('close', () => {
                delete dataConnections[conn.peer];
            });
        }

        function handleData(data, peerId) {
            if (data.type === 'join') {
                addChatMessage('System', data.name + ' joined the session', true);
                addParticipant(data.name);
            } else if (data.type === 'chat') {
                addChatMessage(data.name, data.message);
            } else if (data.type === 'leave') {
                addChatMessage('System', data.name + ' left the session', true);
                removeParticipant(data.name);
            }
        }

        function addVideoStream(stream, name, isLocal, peerId = 'local') {
            // Check if already exists
            if (document.getElementById('video-' + peerId)) {
                return;
            }

            const videoGrid = document.getElementById('videoGrid');
            
            const container = document.createElement('div');
            container.className = 'video-container';
            container.id = 'video-' + peerId;

            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsinline = true;
            if (isLocal) video.muted = true;

            const label = document.createElement('div');
            label.className = 'video-label';
            label.textContent = name;

            const recordingBadge = document.createElement('div');
            recordingBadge.className = 'recording-badge';
            recordingBadge.textContent = '‚è∫ REC';

            container.appendChild(video);
            container.appendChild(label);
            container.appendChild(recordingBadge);
            videoGrid.appendChild(container);

            // Ensure video plays
            video.onloadedmetadata = () => {
                video.play().catch(e => console.log('Play error:', e));
            };

            console.log('Added video for:', name);
        }

        function removeVideoStream(peerId) {
            const videoElement = document.getElementById('video-' + peerId);
            if (videoElement) {
                videoElement.remove();
            }
            delete connections[peerId];
        }

        function addParticipant(name) {
            const list = document.getElementById('participantList');
            const badge = document.createElement('div');
            badge.className = 'participant-badge';
            badge.textContent = name;
            badge.id = 'participant-' + name.replace(/\s/g, '-');
            list.appendChild(badge);
            updateParticipantCount();
        }

        function removeParticipant(name) {
            const badge = document.getElementById('participant-' + name.replace(/\s/g, '-'));
            if (badge) badge.remove();
            updateParticipantCount();
        }

        function updateParticipantCount() {
            const count = document.getElementById('participantList').children.length;
            document.getElementById('participantCount').textContent = count;
        }

        function toggleMic() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    isMuted = !audioTrack.enabled;
                    const btn = document.getElementById('micBtn');
                    btn.classList.toggle('active', isMuted);
                    btn.innerHTML = isMuted ? 'üîá<span class="control-label">Mic</span>' : 'üé§<span class="control-label">Mic</span>';
                }
            }
        }

        function toggleCamera() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    isCameraOff = !videoTrack.enabled;
                    const btn = document.getElementById('camBtn');
                    btn.classList.toggle('active', isCameraOff);
                    btn.innerHTML = isCameraOff ? 'üì∑<span class="control-label">Camera</span>' : 'üìπ<span class="control-label">Camera</span>';
                }
            }
        }

        async function toggleScreen() {
            if (!isScreenSharing) {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: { cursor: "always" },
                        audio: false
                    });

                    const videoTrack = screenStream.getVideoTracks()[0];
                    
                    // Replace video track for all connections
                    Object.values(connections).forEach(call => {
                        const sender = call.peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender) sender.replaceTrack(videoTrack);
                    });

                    // Update local video
                    const localVideo = document.querySelector('#video-local video');
                    if (localVideo) localVideo.srcObject = screenStream;

                    isScreenSharing = true;
                    document.getElementById('screenBtn').classList.add('active');

                    videoTrack.onended = () => stopScreenShare();

                } catch (error) {
                    console.error('Screen share error:', error);
                }
            } else {
                stopScreenShare();
            }
        }

        function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(t => t.stop());
                
                const videoTrack = localStream.getVideoTracks()[0];
                Object.values(connections).forEach(call => {
                    const sender = call.peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
                    if (sender) sender.replaceTrack(videoTrack);
                });

                const localVideo = document.querySelector('#video-local video');
                if (localVideo) localVideo.srcObject = localStream;

                screenStream = null;
                isScreenSharing = false;
                document.getElementById('screenBtn').classList.remove('active');
            }
        }

        function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            try {
                recordedChunks = [];

                // Create canvas for combined video
                const canvas = document.createElement('canvas');
                canvas.width = 1920;
                canvas.height = 1080;
                const ctx = canvas.getContext('2d');

                const canvasStream = canvas.captureStream(30);

                // Mix audio
                const audioContext = new AudioContext();
                const dest = audioContext.createMediaStreamDestination();

                if (localStream.getAudioTracks().length > 0) {
                    const source = audioContext.createMediaStreamSource(localStream);
                    source.connect(dest);
                }

                Object.values(connections).forEach(call => {
                    const stream = call.remoteStream;
                    if (stream && stream.getAudioTracks().length > 0) {
                        const source = audioContext.createMediaStreamSource(stream);
                        source.connect(dest);
                    }
                });

                // Combine streams
                const combinedStream = new MediaStream([
                    ...canvasStream.getVideoTracks(),
                    ...dest.stream.getAudioTracks()
                ]);

                // Draw videos
                function drawFrame() {
                    if (!isRecording) return;

                    ctx.fillStyle = '#1a1a1a';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    const videos = document.querySelectorAll('.video-container video');
                    const count = videos.length;

                    if (count === 1) {
                        ctx.drawImage(videos[0], 0, 0, canvas.width, canvas.height);
                    } else if (count === 2) {
                        const w = canvas.width / 2;
                        videos.forEach((v, i) => {
                            if (v.readyState >= 2) {
                                ctx.drawImage(v, i * w, 0, w, canvas.height);
                            }
                        });
                    } else {
                        const cols = Math.ceil(Math.sqrt(count));
                        const rows = Math.ceil(count / cols);
                        const w = canvas.width / cols;
                        const h = canvas.height / rows;
                        
                        videos.forEach((v, i) => {
                            if (v.readyState >= 2) {
                                const x = (i % cols) * w;
                                const y = Math.floor(i / cols) * h;
                                ctx.drawImage(v, x, y, w, h);
                            }
                        });
                    }

                    requestAnimationFrame(drawFrame);
                }

                drawFrame();

                // Start MediaRecorder
                mediaRecorder = new MediaRecorder(combinedStream, {
                    mimeType: 'video/webm;codecs=vp9,opus',
                    videoBitsPerSecond: 5000000
                });

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `TrainHub-${roomId}-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.webm`;
                    a.click();
                    URL.revokeObjectURL(url);
                    addChatMessage('System', 'Recording saved!', true);
                };

                mediaRecorder.start();
                isRecording = true;

                document.getElementById('recordBtn').classList.add('recording');
                document.querySelectorAll('.recording-badge').forEach(b => b.classList.add('show'));
                addChatMessage('System', 'Recording started', true);

            } catch (error) {
                console.error('Recording error:', error);
                alert('Could not start recording');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('recordBtn').classList.remove('recording');
                document.querySelectorAll('.recording-badge').forEach(b => b.classList.remove('show'));
                addChatMessage('System', 'Recording stopped', true);
            }
        }

        function sendChat() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (message) {
                Object.values(dataConnections).forEach(conn => {
                    if (conn.open) {
                        conn.send({
                            type: 'chat',
                            name: userName,
                            message: message
                        });
                    }
                });

                addChatMessage(userName + ' (You)', message);
                input.value = '';
            }
        }

        function handleChatKey(e) {
            if (e.key === 'Enter') sendChat();
        }

        function addChatMessage(sender, text, isSystem = false) {
            const messages = document.getElementById('chatMessages');
            const msg = document.createElement('div');
            msg.className = isSystem ? 'message system' : 'message';
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            msg.innerHTML = `<strong>${sender}</strong> [${time}]: ${text}`;
            messages.appendChild(msg);
            messages.scrollTop = messages.scrollHeight;
        }

        function leaveSession() {
            if (confirm('Leave the session?')) {
                // Notify others
                Object.values(dataConnections).forEach(conn => {
                    if (conn.open) {
                        conn.send({
                            type: 'leave',
                            name: userName
                        });
                    }
                });

                // Clean up
                if (localStream) localStream.getTracks().forEach(t => t.stop());
                if (screenStream) screenStream.getTracks().forEach(t => t.stop());
                if (isRecording) stopRecording();
                if (peer) peer.destroy();

                // Remove from room
                const roomData = JSON.parse(localStorage.getItem('trainhub-' + roomId) || '{}');
                delete roomData[myPeerId];
                localStorage.setItem('trainhub-' + roomId, JSON.stringify(roomData));

                // Reload page
                location.reload();
            }
        }

        // Cleanup on close
        window.addEventListener('beforeunload', () => {
            if (myPeerId) {
                const roomData = JSON.parse(localStorage.getItem('trainhub-' + roomId) || '{}');
                delete roomData[myPeerId];
                localStorage.setItem('trainhub-' + roomId, JSON.stringify(roomData));
            }
        });
    </script>
</body>
</html>