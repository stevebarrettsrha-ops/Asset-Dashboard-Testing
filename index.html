<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrainHub - Professional Video Conferencing</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1e1e1e;
            color: white;
            overflow: hidden;
            height: 100vh;
        }

        /* Pre-join Screen */
        .prejoin-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .prejoin-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }

        .prejoin-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .prejoin-header h1 {
            font-size: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .prejoin-header p {
            color: #666;
        }

        .video-preview {
            position: relative;
            width: 100%;
            height: 280px;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .video-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-controls {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .preview-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preview-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .preview-btn.off {
            background: #dc3545;
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-join {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-join:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102,126,234,0.4);
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            color: #999;
            position: relative;
        }

        .divider::before,
        .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #ddd;
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .room-id-display {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            border: 2px solid #ffc107;
        }

        .room-id-display strong {
            display: block;
            color: #856404;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .room-code {
            background: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            word-break: break-all;
            margin-bottom: 10px;
        }

        .btn-copy {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Conference Screen */
        .conference-screen {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .conference-screen.active {
            display: flex;
        }

        /* Top Bar */
        .top-bar {
            background: rgba(0,0,0,0.8);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .meeting-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .meeting-title {
            font-size: 18px;
            font-weight: 600;
        }

        .meeting-id {
            background: rgba(255,255,255,0.1);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 13px;
        }

        .top-controls {
            display: flex;
            gap: 10px;
        }

        .top-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .top-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Video Grid */
        .video-stage {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 10px;
            overflow: hidden;
        }

        .main-video-area {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 15px;
            height: 100%;
            overflow-y: auto;
        }

        @media (max-width: 768px) {
            .main-video-area {
                grid-template-columns: 1fr;
            }
        }

        .video-tile {
            position: relative;
            background: #2d2d2d;
            border-radius: 15px;
            overflow: hidden;
            aspect-ratio: 16/9;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .video-tile video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-tile-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .participant-name {
            font-weight: 600;
            font-size: 14px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .video-indicators {
            display: flex;
            gap: 8px;
        }

        .indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .indicator.active {
            background: #dc3545;
        }

        .recording-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            display: none;
            animation: pulse 1.5s infinite;
        }

        .recording-badge.active {
            display: block;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Side Panel */
        .side-panel {
            width: 350px;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            border-left: 1px solid rgba(255,255,255,0.1);
        }

        .side-panel.active {
            display: flex;
        }

        .side-panel-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .side-panel-header h3 {
            font-size: 18px;
        }

        .close-panel {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .side-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .participant-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .participant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-message {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            border-radius: 10px;
        }

        .chat-message strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .chat-input-area {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input-wrapper input {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
        }

        .chat-input-wrapper input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .chat-send-btn {
            background: #667eea;
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        /* Bottom Toolbar */
        .bottom-toolbar {
            background: rgba(0,0,0,0.9);
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            backdrop-filter: blur(10px);
        }

        .toolbar-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 22px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }

        .toolbar-btn.active {
            background: #dc3545;
        }

        .toolbar-btn.recording {
            background: #dc3545;
            animation: pulse 1.5s infinite;
        }

        .toolbar-label {
            position: absolute;
            bottom: -24px;
            font-size: 11px;
            white-space: nowrap;
            color: rgba(255,255,255,0.7);
        }

        .toolbar-btn-leave {
            background: #dc3545;
        }

        .toolbar-btn-leave:hover {
            background: #c82333;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Pre-Join Screen -->
    <div class="prejoin-screen" id="prejoinScreen">
        <div class="prejoin-container">
            <div class="prejoin-header">
                <h1>üéì TrainHub</h1>
                <p>Professional Video Training Platform</p>
            </div>

            <div class="video-preview">
                <video id="previewVideo" autoplay muted playsinline></video>
                <div class="preview-controls">
                    <button class="preview-btn" id="previewMicBtn" onclick="togglePreviewMic()">üé§</button>
                    <button class="preview-btn" id="previewCamBtn" onclick="togglePreviewCam()">üìπ</button>
                </div>
            </div>

            <div class="form-group">
                <label>Your Name</label>
                <input type="text" id="displayName" placeholder="Enter your name">
            </div>

            <button class="btn-join" onclick="startMeeting()">
                üé• Start New Meeting
            </button>

            <div class="divider">OR</div>

            <button class="btn-secondary" onclick="toggleJoinForm()">
                Join Existing Meeting
            </button>

            <div id="joinFormArea" class="hidden">
                <div class="form-group" style="margin-top: 15px;">
                    <label>Meeting ID</label>
                    <input type="text" id="meetingIdInput" placeholder="Enter meeting ID">
                </div>
                <button class="btn-join" onclick="joinMeeting()">
                    üö™ Join Meeting
                </button>
            </div>

            <div id="meetingIdDisplay" class="hidden">
                <div class="room-id-display">
                    <strong>üìã Your Meeting ID - Share this!</strong>
                    <div class="room-code" id="displayRoomCode">Connecting...</div>
                    <button class="btn-copy" onclick="copyMeetingId()">Copy Meeting ID</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Conference Screen -->
    <div class="conference-screen" id="conferenceScreen">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="meeting-info">
                <div class="meeting-title">TrainHub Meeting</div>
                <div class="meeting-id" id="topMeetingId">Meeting ID: <span id="topRoomCode">-</span></div>
            </div>
            <div class="top-controls">
                <button class="top-btn" onclick="copyMeetingId()">üìã Copy ID</button>
                <button class="top-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
            </div>
        </div>

        <!-- Video Stage -->
        <div class="video-stage">
            <div class="main-video-area" id="videoGrid">
                <!-- Video tiles will be added here -->
            </div>

            <!-- Side Panel (Chat/Participants) -->
            <div class="side-panel" id="sidePanel">
                <div class="side-panel-header">
                    <h3 id="panelTitle">Chat</h3>
                    <button class="close-panel" onclick="closeSidePanel()">√ó</button>
                </div>
                <div class="side-panel-content" id="panelContent">
                    <!-- Content will be dynamically loaded -->
                </div>
                <div class="chat-input-area" id="chatInputArea" style="display: none;">
                    <div class="chat-input-wrapper">
                        <input type="text" id="chatMessageInput" placeholder="Type a message..." onkeypress="if(event.key==='Enter')sendChatMessage()">
                        <button class="chat-send-btn" onclick="sendChatMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Toolbar -->
        <div class="bottom-toolbar">
            <button class="toolbar-btn" id="micBtn" onclick="toggleMic()">
                üé§
                <span class="toolbar-label">Mic</span>
            </button>
            <button class="toolbar-btn" id="camBtn" onclick="toggleCamera()">
                üìπ
                <span class="toolbar-label">Camera</span>
            </button>
            <button class="toolbar-btn" id="screenBtn" onclick="toggleScreenShare()">
                üñ•Ô∏è
                <span class="toolbar-label">Screen</span>
            </button>
            <button class="toolbar-btn" id="recBtn" onclick="toggleRecording()">
                ‚è∫
                <span class="toolbar-label">Record</span>
            </button>
            <button class="toolbar-btn" onclick="openChat()">
                üí¨
                <span class="toolbar-label">Chat</span>
            </button>
            <button class="toolbar-btn" onclick="openParticipants()">
                üë•
                <span class="toolbar-label">People</span>
            </button>
            <button class="toolbar-btn toolbar-btn-leave" onclick="leaveMeeting()">
                üìû
                <span class="toolbar-label">Leave</span>
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let peer = null;
        let myPeerId = null;
        let myName = '';
        let localStream = null;
        let previewStream = null;
        let connections = {};
        let dataConnections = {};
        let previewMuted = false;
        let previewCamOff = false;
        let isMuted = false;
        let isCamOff = false;
        let isScreenSharing = false;
        let screenStream = null;
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];

        // Initialize preview
        window.addEventListener('load', async () => {
            try {
                previewStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                document.getElementById('previewVideo').srcObject = previewStream;
            } catch (err) {
                console.error('Preview error:', err);
                alert('Could not access camera/microphone. Please check permissions.');
            }
        });

        function togglePreviewMic() {
            if (previewStream) {
                const track = previewStream.getAudioTracks()[0];
                if (track) {
                    track.enabled = !track.enabled;
                    previewMuted = !track.enabled;
                    document.getElementById('previewMicBtn').classList.toggle('off', previewMuted);
                }
            }
        }

        function togglePreviewCam() {
            if (previewStream) {
                const track = previewStream.getVideoTracks()[0];
                if (track) {
                    track.enabled = !track.enabled;
                    previewCamOff = !track.enabled;
                    document.getElementById('previewCamBtn').classList.toggle('off', previewCamOff);
                }
            }
        }

        function toggleJoinForm() {
            document.getElementById('joinFormArea').classList.toggle('hidden');
        }

        async function startMeeting() {
            myName = document.getElementById('displayName').value.trim();
            if (!myName) {
                alert('Please enter your name');
                return;
            }

            try {
                if (!previewStream) {
                    previewStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                }

                localStream = previewStream;

                peer = new Peer();

                peer.on('open', (id) => {
                    myPeerId = id;
                    console.log('Meeting started. ID:', id);
                    
                    document.getElementById('displayRoomCode').textContent = id;
                    document.getElementById('meetingIdDisplay').classList.remove('hidden');
                    
                    setTimeout(() => {
                        enterConference();
                    }, 1500);
                });

                peer.on('call', handleIncomingCall);
                peer.on('connection', handleIncomingData);
                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    alert('Connection error: ' + err.type);
                });

            } catch (err) {
                console.error('Error:', err);
                alert('Could not start meeting: ' + err.message);
            }
        }

        async function joinMeeting() {
            myName = document.getElementById('displayName').value.trim();
            const hostId = document.getElementById('meetingIdInput').value.trim();

            if (!myName) {
                alert('Please enter your name');
                return;
            }
            if (!hostId) {
                alert('Please enter Meeting ID');
                return;
            }

            try {
                if (!previewStream) {
                    previewStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                }

                localStream = previewStream;

                peer = new Peer();

                peer.on('open', (id) => {
                    myPeerId = id;
                    console.log('Joining meeting. My ID:', id);
                    
                    enterConference();
                    
                    // Call host
                    const call = peer.call(hostId, localStream, { metadata: { name: myName } });
                    handleOutgoingCall(call);

                    // Connect data
                    const conn = peer.connect(hostId, { metadata: { name: myName } });
                    setupDataConnection(conn);
                });

                peer.on('call', handleIncomingCall);
                peer.on('connection', handleIncomingData);
                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    alert('Connection error: ' + err.type);
                });

            } catch (err) {
                console.error('Error:', err);
                alert('Could not join meeting: ' + err.message);
            }
        }

        function enterConference() {
            document.getElementById('prejoinScreen').style.display = 'none';
            document.getElementById('conferenceScreen').classList.add('active');
            document.getElementById('topRoomCode').textContent = myPeerId;
            
            addVideoTile(localStream, myName + ' (You)', 'local', true);
            addChatMsg('System', 'You joined the meeting', true);
        }

        function handleIncomingCall(call) {
            console.log('Incoming call from:', call.peer);
            call.answer(localStream);
            handleOutgoingCall(call);
        }

        function handleOutgoingCall(call) {
            call.on('stream', (remoteStream) => {
                console.log('Received stream from:', call.peer);
                const name = call.metadata?.name || 'Guest';
                addVideoTile(remoteStream, name, call.peer, false);
                addChatMsg('System', name + ' joined the meeting', true);
            });

            call.on('close', () => {
                removeVideoTile(call.peer);
            });

            connections[call.peer] = call;
        }

        function handleIncomingData(conn) {
            setupDataConnection(conn);
        }

        function setupDataConnection(conn) {
            dataConnections[conn.peer] = conn;

            conn.on('open', () => {
                console.log('Data connection open:', conn.peer);
                conn.send({ type: 'join', name: myName });
            });

            conn.on('data', (data) => {
                if (data.type === 'join') {
                    addChatMsg('System', data.name + ' joined', true);
                } else if (data.type === 'chat') {
                    addChatMsg(data.name, data.message);
                }
            });
        }

        function addVideoTile(stream, name, id, isLocal) {
            if (document.getElementById('tile-' + id)) return;

            const grid = document.getElementById('videoGrid');
            const tile = document.createElement('div');
            tile.className = 'video-tile';
            tile.id = 'tile-' + id;

            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsinline = true;
            if (isLocal) video.muted = true;

            const overlay = document.createElement('div');
            overlay.className = 'video-tile-overlay';
            overlay.innerHTML = `
                <div class="participant-name">${name}</div>
                <div class="video-indicators">
                    <div class="indicator" id="mic-${id}">üé§</div>
                </div>
            `;

            const recBadge = document.createElement('div');
            recBadge.className = 'recording-badge';
            recBadge.textContent = '‚è∫ REC';

            tile.appendChild(video);
            tile.appendChild(overlay);
            tile.appendChild(recBadge);
            grid.appendChild(tile);

            video.play().catch(e => console.log('Play error:', e));
        }

        function removeVideoTile(id) {
            const tile = document.getElementById('tile-' + id);
            if (tile) tile.remove();
        }

        function toggleMic() {
            if (localStream) {
                const track = localStream.getAudioTracks()[0];
                if (track) {
                    track.enabled = !track.enabled;
                    isMuted = !track.enabled;
                    document.getElementById('micBtn').classList.toggle('active', isMuted);
                    
                    const indicator = document.getElementById('mic-local');
                    if (indicator) {
                        indicator.classList.toggle('active', isMuted);
                        indicator.textContent = isMuted ? 'üîá' : 'üé§';
                    }
                }
            }
        }

        function toggleCamera() {
            if (localStream) {
                const track = localStream.getVideoTracks()[0];
                if (track) {
                    track.enabled = !track.enabled;
                    isCamOff = !track.enabled;
                    document.getElementById('camBtn').classList.toggle('active', isCamOff);
                }
            }
        }

        async function toggleScreenShare() {
            if (!isScreenSharing) {
                try {
                    screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const track = screenStream.getVideoTracks()[0];
                    
                    Object.values(connections).forEach(call => {
                        const sender = call.peerConnection.getSenders().find(s => s.track?.kind === 'video');
                        if (sender) sender.replaceTrack(track);
                    });

                    const localVideo = document.querySelector('#tile-local video');
                    if (localVideo) localVideo.srcObject = screenStream;

                    isScreenSharing = true;
                    document.getElementById('screenBtn').classList.add('active');

                    track.onended = () => stopScreenShare();
                } catch (err) {
                    console.error('Screen share error:', err);
                }
            } else {
                stopScreenShare();
            }
        }

        function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(t => t.stop());
                
                const track = localStream.getVideoTracks()[0];
                Object.values(connections).forEach(call => {
                    const sender = call.peerConnection.getSenders().find(s => s.track?.kind === 'video');
                    if (sender) sender.replaceTrack(track);
                });

                const localVideo = document.querySelector('#tile-local video');
                if (localVideo) localVideo.srcObject = localStream;

                screenStream = null;
                isScreenSharing = false;
                document.getElementById('screenBtn').classList.remove('active');
            }
        }

        function toggleRecording() {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }

        function startRecording() {
            try {
                recordedChunks = [];
                const canvas = document.createElement('canvas');
                canvas.width = 1920;
                canvas.height = 1080;
                const ctx = canvas.getContext('2d');
                const stream = canvas.captureStream(30);

                const audioCtx = new AudioContext();
                const dest = audioCtx.createMediaStreamDestination();
                if (localStream.getAudioTracks()[0]) {
                    audioCtx.createMediaStreamSource(localStream).connect(dest);
                }

                const combined = new MediaStream([
                    ...stream.getVideoTracks(),
                    ...dest.stream.getAudioTracks()
                ]);

                function draw() {
                    if (!isRecording) return;
                    ctx.fillStyle = '#1e1e1e';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    const videos = document.querySelectorAll('.video-tile video');
                    const count = videos.length;

                    if (count === 1 && videos[0].readyState >= 2) {
                        ctx.drawImage(videos[0], 0, 0, canvas.width, canvas.height);
                    } else {
                        const cols = Math.ceil(Math.sqrt(count));
                        const w = canvas.width / cols;
                        const h = canvas.height / Math.ceil(count / cols);
                        videos.forEach((v, i) => {
                            if (v.readyState >= 2) {
                                ctx.drawImage(v, (i % cols) * w, Math.floor(i / cols) * h, w, h);
                            }
                        });
                    }
                    requestAnimationFrame(draw);
                }
                draw();

                mediaRecorder = new MediaRecorder(combined);
                mediaRecorder.ondataavailable = e => { 
                    if (e.data.size > 0) recordedChunks.push(e.data); 
                };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `TrainHub-Meeting-${Date.now()}.webm`;
                    a.click();
                    addChatMsg('System', 'Recording saved to downloads!', true);
                };

                mediaRecorder.start();
                isRecording = true;
                document.getElementById('recBtn').classList.add('recording');
                document.querySelectorAll('.recording-badge').forEach(b => b.classList.add('active'));
                addChatMsg('System', 'Recording started', true);

            } catch (err) {
                console.error('Recording error:', err);
                alert('Could not start recording');
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                document.getElementById('recBtn').classList.remove('recording');
                document.querySelectorAll('.recording-badge').forEach(b => b.classList.remove('active'));
                addChatMsg('System', 'Recording stopped', true);
            }
        }

        function openChat() {
            const panel = document.getElementById('sidePanel');
            const panelContent = document.getElementById('panelContent');
            const chatInput = document.getElementById('chatInputArea');
            
            document.getElementById('panelTitle').textContent = 'Chat';
            chatInput.style.display = 'block';
            
            panelContent.innerHTML = '<div class="chat-messages" id="chatMessages"></div>';
            
            // Restore messages
            const existingMessages = window.chatHistory || [];
            existingMessages.forEach(msg => {
                const msgEl = document.createElement('div');
                msgEl.className = msg.isSystem ? 'chat-message' : 'chat-message';
                msgEl.innerHTML = msg.isSystem ? 
                    `<em style="color: #999;">${msg.text}</em>` :
                    `<strong>${msg.sender}</strong>${msg.text}`;
                document.getElementById('chatMessages').appendChild(msgEl);
            });
            
            panel.classList.add('active');
        }

        function openParticipants() {
            const panel = document.getElementById('sidePanel');
            const panelContent = document.getElementById('panelContent');
            const chatInput = document.getElementById('chatInputArea');
            
            document.getElementById('panelTitle').textContent = 'Participants';
            chatInput.style.display = 'none';
            
            panelContent.innerHTML = `
                <div class="participant-item">
                    <div class="participant-avatar">${myName.charAt(0).toUpperCase()}</div>
                    <div>${myName} (You)</div>
                </div>
            `;
            
            Object.keys(connections).forEach((peerId, index) => {
                const call = connections[peerId];
                const name = call.metadata?.name || 'Guest ' + (index + 1);
                panelContent.innerHTML += `
                    <div class="participant-item">
                        <div class="participant-avatar">${name.charAt(0).toUpperCase()}</div>
                        <div>${name}</div>
                    </div>
                `;
            });
            
            panel.classList.add('active');
        }

        function closeSidePanel() {
            document.getElementById('sidePanel').classList.remove('active');
        }

        function sendChatMessage() {
            const input = document.getElementById('chatMessageInput');
            const msg = input.value.trim();
            if (!msg) return;

            Object.values(dataConnections).forEach(conn => {
                if (conn.open) {
                    conn.send({ type: 'chat', name: myName, message: msg });
                }
            });

            addChatMsg(myName + ' (You)', msg);
            input.value = '';
        }

        function addChatMsg(sender, text, isSystem = false) {
            if (!window.chatHistory) window.chatHistory = [];
            window.chatHistory.push({ sender, text, isSystem });

            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                const msg = document.createElement('div');
                msg.className = 'chat-message';
                msg.innerHTML = isSystem ? 
                    `<em style="color: #999;">${text}</em>` :
                    `<strong>${sender}</strong>${text}`;
                chatMessages.appendChild(msg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function copyMeetingId() {
            if (myPeerId) {
                navigator.clipboard.writeText(myPeerId).then(() => {
                    alert('Meeting ID copied to clipboard!');
                });
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function leaveMeeting() {
            if (confirm('Leave the meeting?')) {
                if (localStream) localStream.getTracks().forEach(t => t.stop());
                if (previewStream) previewStream.getTracks().forEach(t => t.stop());
                if (screenStream) screenStream.getTracks().forEach(t => t.stop());
                if (isRecording) stopRecording();
                if (peer) peer.destroy();
                location.reload();
            }
        }
    </script>
</body>
</html>